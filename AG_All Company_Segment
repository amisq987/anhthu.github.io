bảng adprofile
root
 |-- YearMonth: integer (nullable = true)
 |-- UpdatedToDate: timestamp (nullable = true)
 |-- AGChannel: string (nullable = true)
 |-- AGCode: integer (nullable = true)
 |-- AGName: string (nullable = true)
 |-- Gender: string (nullable = true)
 |-- MaritalStatus: string (nullable = true)
 |-- ClientNum: string (nullable = true)
 |-- IDNumber: string (nullable = true)
 |-- DateOfBirth: timestamp (nullable = true)
 |-- LastTerDate: timestamp (nullable = true)
 |-- LastReinsDate: timestamp (nullable = true)
 |-- FirstAppointedDate: timestamp (nullable = true)
 |-- FirstAppointedDate_Num: integer (nullable = true)
 |-- AppointedDate: timestamp (nullable = true)
 |-- AppointedDate_Num: integer (nullable = true)
 |-- TerDate: timestamp (nullable = true)
 |-- TerDate_Num: integer (nullable = true)
 |-- AGLevel: string (nullable = true)
 |-- AGStatus: string (nullable = true)
 |-- AGType: string (nullable = true)
 |-- AGSegCode: integer (nullable = true)
 |-- AGSegName: string (nullable = true)
 |-- MAPASegCode: integer (nullable = true)
 |-- MAPASubSegCode: integer (nullable = true)
 |-- MAPASegName: string (nullable = true)
 |-- PMUnitCode: string (nullable = true)
 |-- PMCode: integer (nullable = true)
 |-- UnitCode: string (nullable = true)
 |-- LeaderCode: integer (nullable = true)
 |-- BranchCode: string (nullable = true)
 |-- BMCode: integer (nullable = true)
 |-- RegionCode: string (nullable = true)
 |-- OfficeCode: string (nullable = true)
 |-- GACode: string (nullable = true)
 |-- OfficeCoverCode: string (nullable = true)
 |-- GACoverCode: string (nullable = true)
 |-- GACode_After1Year: string (nullable = true)
 |-- PUM_PromotionType: string (nullable = true)
 |-- PEGold_QualifiedCondition: string (nullable = true)
 |-- AGType_PrevQ: string (nullable = true)
 |-- AGType_NextQ: string (nullable = true)
 |-- AGLevel_PrevQ: string (nullable = true)
 |-- AGLevel_NextQ: string (nullable = true)
 |-- ContactProvince_Code: string (nullable = true)
 |-- ContactProvince_Name: string (nullable = true)
 |-- PermanentProvince_Code: string (nullable = true)
 |-- PermanentProvince_Name: string (nullable = true)
 |-- EducationCode: string (nullable = true)
 |-- EducationName: string (nullable = true)
 |-- OccupationCode: string (nullable = true)
 |-- OccupationName: string (nullable = true)
 |-- AGTenureSegment: string (nullable = true)
 |-- MDRTTracking: string (nullable = true)
 |-- DateCreated: timestamp (nullable = true)
 |-- UserID: string (nullable = true)
 |-- Email: string (nullable = true)
 |-- MonthOfService: short (nullable = true)
 |-- Phone1: string (nullable = true)
 |-- Phone2: string (nullable = true)
 |-- Phone3: string (nullable = true)
 |-- DoGen: string (nullable = true)
 |-- AG_Rein_Month: integer (nullable = true)
 |-- AGFlag: string (nullable = true)

bảng prodtrans_filtered_df
root
 |-- YearMonth: integer (nullable = true)
 |-- UpdatedToDate: timestamp (nullable = true)
 |-- Channels: string (nullable = true)
 |-- FromSource: integer (nullable = true)
 |-- TransDate: integer (nullable = true)
 |-- GACode: string (nullable = true)
 |-- SoldUnit: string (nullable = true)
 |-- AGCode: integer (nullable = true)
 |-- ClientNum: string (nullable = true)
 |-- ProposalNum: string (nullable = true)
 |-- PolicyNum: integer (nullable = true)
 |-- ProductCode: string (nullable = true)
 |-- ProductType: string (nullable = true)
 |-- Frequency: short (nullable = true)
 |-- PolicyStatus: string (nullable = true)
 |-- AFICFI_Status: string (nullable = true)
 |-- CFI_Date: timestamp (nullable = true)
 |-- RecievedLetterDate: timestamp (nullable = true)
 |-- FreeLookDate: timestamp (nullable = true)
 |-- PremiumTerm: integer (nullable = true)
 |-- ProposalDate: integer (nullable = true)
 |-- FirstIssuedDate: integer (nullable = true)
 |-- CaseCount: float (nullable = true)
 |-- Case_Sub: float (nullable = true)
 |-- Case_Iss: float (nullable = true)
 |-- APE: double (nullable = true)
 |-- APE_Sub: double (nullable = true)
 |-- APE_Iss: double (nullable = true)
 |-- CaseCount_2: float (nullable = true)
 |-- Case_Sub_2: float (nullable = true)
 |-- Case_Iss_2: float (nullable = true)
 |-- APE_2: double (nullable = true)
 |-- APE_Sub_2: double (nullable = true)
 |-- APE_Iss_2: double (nullable = true)
 |-- IP: double (nullable = true)
 |-- IP_Sub: double (nullable = true)
 |-- IP_Iss: double (nullable = true)
 |-- SC: double (nullable = true)
 |-- FYP: double (nullable = true)
 |-- SYP: double (nullable = true)
 |-- RYP: double (nullable = true)
 |-- FYC: double (nullable = true)
 |-- Topup: double (nullable = true)
 |-- APE_AFI: double (nullable = true)
 |-- APE_CFI: double (nullable = true)
 |-- APE_AFI_Full: double (nullable = true)
 |-- APE_CFI_Full: double (nullable = true)
 |-- UnitCode_ForGrowth: string (nullable = true)
 |-- GACode_ForGrowth: string (nullable = true)
 |-- GACode_byTrans: string (nullable = true)
 |-- RegionCode_ByTrans: string (nullable = true)
 |-- UnitCode_ByTrans: string (nullable = true)
 |-- BranchCode_ByTrans: string (nullable = true)
 |-- Main_AGCode: integer (nullable = true)
 |-- CreatedDate: timestamp (nullable = true)
 |-- UserID: string (nullable = true)
 |-- AGFlag: string (nullable = true)

bảng  ADStructure
root
 |-- YearMonth: integer (nullable = true)
 |-- UpdatedToDate: timestamp (nullable = true)
 |-- GACode: string (nullable = true)
 |-- GAType: string (nullable = true)
 |-- GACoverCode: string (nullable = true)
 |-- MotherGACode: string (nullable = true)
 |-- GAStatus: string (nullable = true)
 |-- OpenDate: timestamp (nullable = true)
 |-- ClosedDate: timestamp (nullable = true)
 |-- GADCode: integer (nullable = true)
 |-- GADName: string (nullable = true)
 |-- GASegCode: string (nullable = true)
 |-- GASegName: string (nullable = true)
 |-- GATitle: string (nullable = true)
 |-- OfficeCode: string (nullable = true)
 |-- OfficeName: string (nullable = true)
 |-- OfficeCoverCode: string (nullable = true)
 |-- OfficeCoverName: string (nullable = true)
 |-- ProvinceCode: string (nullable = true)
 |-- ProvinceName: string (nullable = true)
 |-- ADStrucCode4: string (nullable = true)
 |-- ADStrucName4: string (nullable = true)
 |-- ADHeadCode4: string (nullable = true)
 |-- ADHeadName4: string (nullable = true)
 |-- ADLoginID4: string (nullable = true)
 |-- ADStrucCode3: string (nullable = true)
 |-- ADStrucName3: string (nullable = true)
 |-- ADHeadCode3: string (nullable = true)
 |-- ADHeadName3: string (nullable = true)
 |-- ADLoginID3: string (nullable = true)
 |-- ADStrucCode2: string (nullable = true)
 |-- ADStrucName2: string (nullable = true)
 |-- ADHeadCode2: string (nullable = true)
 |-- ADHeadName2: string (nullable = true)
 |-- ADLoginID2: string (nullable = true)
 |-- ADStrucCode1: string (nullable = true)
 |-- ADStrucName1: string (nullable = true)
 |-- ADHeadCode1: string (nullable = true)
 |-- ADHeadName1: string (nullable = true)
 |-- ADStrucCode1_Order: integer (nullable = true)
 |-- ADLoginID1: string (nullable = true)
 |-- ADStrucCode0: string (nullable = true)
 |-- ADStrucName0: string (nullable = true)
 |-- ADHeadCode0: string (nullable = true)
 |-- ADHeadName0: string (nullable = true)
 |-- ADLoginID0: string (nullable = true)
 |-- GADEmail1: string (nullable = true)
 |-- GADEmail2: string (nullable = true)
 |-- GADEmail3: string (nullable = true)
 |-- GADGenderSalutation: string (nullable = true)
 |-- ForFullProduction: integer (nullable = true)
 |-- ForGrowthAfter1Yr: integer (nullable = true)
 |-- GroupGAFlag: integer (nullable = true)
 |-- Spinoff_Check: integer (nullable = true)
 |-- OfficeAddress: string (nullable = true)
 |-- OfficeLattitude: float (nullable = true)
 |-- OfficeLonglitude: float (nullable = true)
 |-- DateCreated: timestamp (nullable = true)
 |-- UserID: string (nullable = true)
 |-- GACoverSegName: string (nullable = true)

bảng GLStructure
root
 |-- YearMonth: integer (nullable = true)
 |-- UpdatedToDate: timestamp (nullable = true)
 |-- AGCode: integer (nullable = true)
 |-- AGLevel: string (nullable = true)
 |-- AGType: string (nullable = true)
 |-- Title01: string (nullable = true)
 |-- Title02: string (nullable = true)
 |-- Title03: string (nullable = true)
 |-- EffFrom: integer (nullable = true)
 |-- EffTo: integer (nullable = true)
 |-- MOC_Status: string (nullable = true)
 |-- ReleasedDate: integer (nullable = true)
 |-- DueDate: integer (nullable = true)
 |-- OfficeCode: string (nullable = true)
 |-- OfficeName: string (nullable = true)
 |-- BatchRecruit_Code: string (nullable = true)
 |-- BatchRecruit_Name: string (nullable = true)
 |-- GL_StrucCode3: string (nullable = true)
 |-- GL_StrucName3: string (nullable = true)
 |-- GL_StrucCode2: string (nullable = true)
 |-- GL_StrucName2: string (nullable = true)
 |-- GL_StrucCode1: string (nullable = true)
 |-- GL_StrucName1: string (nullable = true)
 |-- GL_StrucCode0: string (nullable = true)
 |-- GL_StrucName0: string (nullable = true)
 |-- GL_HeadCode3: string (nullable = true)
 |-- GL_HeadName3: string (nullable = true)
 |-- GL_HeadCode2: string (nullable = true)
 |-- GL_HeadName2: string (nullable = true)
 |-- GL_HeadCode1: string (nullable = true)
 |-- GL_HeadName1: string (nullable = true)
 |-- GL_HeadCode0: string (nullable = true)
 |-- GL_HeadName0: string (nullable = true)
 |-- DateCreated: timestamp (nullable = true)
 |-- UserID: string (nullable = true)
 |-- BDM_Name: string (nullable = true)
 |-- BDD_Name: string (nullable = true)
 |-- TH_Name: string (nullable = true)
 |-- SubZone: string (nullable = true)
 |-- RegionCode: string (nullable = true)
 |-- AGFlag: string (nullable = true)
from pyspark.sql.functions import col, when, concat, lit, sum as _sum

# Step 1: Enrich adprofile
adprofile_enriched_df = adprofile_filtered_df \
    .filter(col("AGSegName") != "Termination") \
    .withColumn(
        "segment_final",
        when(col("AGSegName") == "SA", "SA")
        .when((col("AGSegName").isin("Gold", "Platinum", "Diamond")) & (col("MonthOfService") <= 12), "New PE")
        .when((col("AGSegName").isin("Gold", "Platinum", "Diamond")) & (col("MonthOfService") > 12), col("AGSegName"))
        .when((col("MonthOfService").between(0, 12)), concat(lit("M"), col("MonthOfService").cast("string")))
        .otherwise("M13+")
    )

# Step 2: Prepare prodtrans_agg_df
prodtrans_agg_df = prodtrans_filtered_df.groupBy("AGCode").agg(
    _sum("APE").alias("APE"),
    _sum("CaseCount").alias("Case"),
    _sum(when(col("IP") >= 15000000, col("CaseCount")).otherwise(0)).alias("Case_IP_15_excl_digital")
).withColumn("Active_IP_15", when(col("Case_IP_15_excl_digital") > 0, 1).otherwise(0)) \
 .withColumn("Active_net", when(col("Case") > 0, 1).otherwise(0))

# Step 3: Process Agency data
adstructure_selected_df = adstructure_filtered_df.select("YearMonth", col("ADStrucCode1").alias("Territory"), "OfficeCode")

agency_df = adprofile_enriched_df.filter(col("AGChannel") == "Agency") \
    .join(adstructure_selected_df, ["YearMonth", "OfficeCode"], "left") \
    .join(prodtrans_agg_df, "AGCode", "left") \
    .withColumn("Manpower", lit(1))

# Step 4: Get existing territories from Agency
existing_territory_list = [row.Territory for row in agency_df.select("Territory").distinct().collect()]

# Step 5: Process Gallerie data with glstructure
gallerie_df = adprofile_enriched_df.filter(col("AGChannel") == "Gallerie") \
    .join(glstructure_filtered_df.select(col("GL_StrucCode1").alias("Territory"), "OfficeCode"), "OfficeCode", "inner") \
    .join(prodtrans_agg_df, "AGCode", "left") \
    .withColumn(
        "Territory",
        when(~col("Territory").isin(existing_territory_list), "GAL").otherwise(col("Territory"))
    ) \
    .withColumn("Manpower", lit(1))

# Step 6: Union Agency and Gallerie datasets
combined_df = agency_df.unionByName(gallerie_df)

# Step 7: Aggregate
result_df = combined_df.groupBy(
    "AGChannel", "YearMonth", "Territory", "OfficeCode", "segment_final"
).agg(
    _sum("APE").alias("APE"),
    _sum("Manpower").alias("Manpower"),
    _sum("Active_net").alias("Active_net"),
    _sum("Active_IP_15").alias("Active_IP_15"),
    _sum("Case").alias("Case"),
    _sum("Case_IP_15_excl_digital").alias("Case_IP_15_excl_digital")
)

# Step 8: Display
result_df.orderBy("AGChannel", "YearMonth", "Territory", "OfficeCode", "segment_final").display()
